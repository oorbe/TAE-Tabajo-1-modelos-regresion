---
title: "consolidacion de datos"
author: "Oliver Rodriguez, juan pajoy, sara hoyos, juan ortega, juan carvajal"
date: "31/3/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(fastDummies)
library(tidyverse)
# Funciones a utilizar 
#Con esta función cambio los NA por ceros
change_na <- function(x){
  ifelse(is.na(x),0,x)
}
```

# TABLAS PERSONAS

carateristicas y composicion del hogar:

```{r}
d_f <- read.csv('Caracteristicas y composicion del hogar.csv', header = T, sep = ';')

no_hijos <-   d_f %>% 
  group_by(ï..DIRECTORIO, SECUENCIA_P) %>% # agrupo por vivienda y hogar
  dplyr::filter(P6051 == 3) %>% # Selecciono el parentesco con jefe de hogar 3= hij@ o hijastr@
  count(P6051) #Cuento esas frecuencias

df1 <- d_f %>% select(ï..DIRECTORIO,SECUENCIA_ENCUESTA,SECUENCIA_P,P6040,P6071,P6087,
                       P6088,P6080, P2057,P1895)

# defino los nombres de las columnas
colnames(df1) <- c('ï..DIRECTORIO','SECUENCIA_ENCUESTA','SECUENCIA_P','edad', 'vive_con_conyuge', 'nvl_educacion_papa', 'nvl_educacion_mama', 'rasgos', 'campesino', 'satisfaccion_vida')

df_2 <- no_hijos %>%  # volvemos a el estado normal mostrando el numero de hijo por hogar
  full_join(df1,by = c('ï..DIRECTORIO' = 'ï..DIRECTORIO', 'SECUENCIA_P'='SECUENCIA_P'))

# PARA NA´s:
# n: Son los que notiene hijos ->0
# vive_con_conyuge: 3 = no tiene 
# nvl_educacion_papa: ninguno = 0 
# nvl_educacion_mama: ninguno = 0
# campesino: = si = 1 pero quiero ver el comportamiento de estos valores
# s_vida        s_ingreso        s_salud  s_seguridad    s_actividad_actual    escalon: mediana= 8 muy curioso todas
# estas V tienen los mismos NA's. 74700 (son los menores niños de 15 año)
df_2 <- df_2 %>% replace_na(list(n=0,vive_con_conyuge=3,
                                 nvl_educacion_papa=0, nvl_educacion_mama=0,
                                 campesino=2)) # Reemplazo los NA's los cuales serán aqullos que no tiene hijos.

df_2[is.na(df_2)] <- 8 # para los s... les pongo la mediana
colSums(is.na(df_2)) # listo

# Algunos reeemplazos:
# Reemplzo nvl educa 9 y 10 por o los cuales son sin estudio
df_2$nvl_educacion_mama[which(df_2$nvl_educacion_mama == 10 | df_2$nvl_educacion_mama==9)] <- 0
df_2$nvl_educacion_papa[which(df_2$nvl_educacion_papa == 10 | df_2$nvl_educacion_papa==9)] <- 0
df_2$rasgos <- ifelse(df_2$rasgos == 6, 0, 1) # ninguno=0, alguno=1
caracteristicas <- df_2[,-3] # elimino P6051

caracteristicas <- caracteristicas %>% ungroup()# desagrupo para poder hacer cambios con mutate



rm(d_f); rm(df1); rm(no_hijos); rm(df_2)


```

# Fuerza de trabajo :

```{r}
#Selección variables y renombrado
base <- read.csv('Fuerza de trabajo.csv',sep = ';')
df1 <- base %>% select(ï..DIRECTORIO,SECUENCIA_ENCUESTA,SECUENCIA_P,P6240,P8624,P415)
colnames(df1) <- c('ï..DIRECTORIO','SECUENCIA_ENCUESTA','SECUENCIA_P','actividad_semana_pasada', 'ganancia_mes', 'horas')
#Conversión a categoría
#cols <- c("actividad_semana_pasada","sostenimiento_hijos")
#df1[,cols] <- lapply(df1[,cols], factor)
#Manejo de nulos
df1$actividad_semana_pasada[is.na(df1$actividad_semana_pasada)] <- "6"
df1$ganancia_mes[is.na(df1$ganancia_mes)] <- "0"
df1$horas[is.na(df1$horas)] <- "0"
fuerza <- df1
rm(base) ; rm(df1)
```

BASE TECNOLOGIAS DE INFO Y COMUNICACIÓN (TIC)

```{r}
 
Dt_TIC <- read.csv("Tecnologías de información y comunicación.csv",header = TRUE,sep = ";")
# Con esta BD observamos si los hogares con mayor dispositivos con acceso a internet son los que 
# posiblemente mayor numero de hijos tiene
Dt_TIC <- as_tibble(subset(Dt_TIC,select = c("ï..DIRECTORIO","SECUENCIA_ENCUESTA","SECUENCIA_P","ORDEN","P765S1",            
                                             "P765S2","P765S3","P765S4","P765S5","P765S6","P765S7","P765S8")))
colnames(Dt_TIC) <- c("ï..DIRECTORIO","SECUENCIA_ENCUESTA","SECUENCIA_P","ORDEN","PC_ESCRITORIO",            
                      "PC_PORTATIL","TABLETA","CELULAR","CONSOLAS","TV","MP3_4")
any(is.na(Dt_TIC)) 
colSums (is.na ( Dt_TIC ))
Dt_TIC <- data.frame(sapply(Dt_TIC, change_na))
# Los valores NA's presentes en  Dt_TIC se refiere a que no poseen ese dispositivo con acceso 
# a internet por lo tanto reemplazamos ese valor NA por un cero absoluto
## OBEJITVO: Sumar el numero de dispositivos con acceso a internet y crear una nueva variable 
# a partir de estas con el fin de responder a la pregunta entre mas dispositivos tenga una familia
# con acceso a internet es motivo para tener mas hijos
# Nueva variable para Dt_TIC
Dt_TIC$TOT_DISPOSITIVOS <- rowSums(Dt_TIC[,c("PC_ESCRITORIO","PC_PORTATIL","TABLETA","CELULAR",
                                             "CONSOLAS","TV","MP3_4")])

Dt_TIC <- Dt_TIC[,c("ï..DIRECTORIO","SECUENCIA_ENCUESTA","SECUENCIA_P",'TOT_DISPOSITIVOS')]
```

BASE SALUD

```{r}

Dt_Salud <- read.csv("Salud.csv",header = TRUE,sep = ";")
Dt_Salud <- as_tibble(subset(Dt_Salud,select = c("ï..DIRECTORIO","SECUENCIA_ENCUESTA","SECUENCIA_P","P6090",
                                                 "P6100","P1708S1")))
colnames(Dt_Salud) <- c("ï..DIRECTORIO","SECUENCIA_ENCUESTA","SECUENCIA_P","A_EPS",
                        "SEG_SOCIAL_SALUD","1ER_HIJO_EDAD")

any(is.na(Dt_Salud)) 
colSums (is.na ( Dt_Salud ))
Dt_Salud <- data.frame(sapply(Dt_Salud, change_na))

# recodificamos la cariable seguridad social:
Dt_Salud <- Dt_Salud %>% 
    mutate(SEG_SOCIAL_SALUD = case_when(
      Dt_Salud$SEG_SOCIAL_SALUD <= 2 ~  1 # contributivo eps o especial 
      ,Dt_Salud$SEG_SOCIAL_SALUD == 3 ~ 2 # subcidiado
      ,Dt_Salud$SEG_SOCIAL_SALUD == 9 ~ 3 # no sabe
))
  
```

# uniones tablas personas:

```{r}
#unimos labases de  personas
p1 <- caracteristicas %>% 
  full_join(fuerza, by=c('ï..DIRECTORIO'='ï..DIRECTORIO', 'SECUENCIA_P'='SECUENCIA_P'
                         ,'SECUENCIA_ENCUESTA'='SECUENCIA_ENCUESTA'))

p2 <- p1 %>% 
  full_join(Dt_Salud, by=c('ï..DIRECTORIO'='ï..DIRECTORIO', 'SECUENCIA_P'='SECUENCIA_P'
                         ,'SECUENCIA_ENCUESTA'='SECUENCIA_ENCUESTA'))

p3 <- p2 %>% 
  full_join(Dt_TIC, by=c('ï..DIRECTORIO'='ï..DIRECTORIO', 'SECUENCIA_P'='SECUENCIA_P'
                         ,'SECUENCIA_ENCUESTA'='SECUENCIA_ENCUESTA'))

# se remueven las tablas que ya no sirven
rm(p1);rm(p2)
rm(caracteristicas) ; rm(Dt_TIC) ; rm(Dt_Salud); rm(fuerza)


  p3 <- p3 %>% 
    mutate(nvl_educacion_papa = case_when(
      p3$nvl_educacion_papa <= 5 ~  0 # 'Secundaria o menos'
      ,p3$nvl_educacion_papa >= 6 ~ 1 # educacion superios
    ))
  
  p3 <- p3 %>% 
    mutate(nvl_educacion_mama = case_when(
      p3$nvl_educacion_mama <= 5 ~  0 # 'Secundaria o meno
      ,p3$nvl_educacion_mama >= 6 ~ 1 # educacion superios

    ))
  
# se eleiminan algunas varaibles que ya no consideramos importante:
p3 <- p3[,-11]
```

# Tablas Hogar:

Uso de energéticos del hogar:

```{r}
ener_hogar <- read.csv('Uso de energéticos del hogar.csv', sep=';')
ener_hogar <- ener_hogar %>% select(ï..DIRECTORIO,SECUENCIA_ENCUESTA, ORDEN,SECUENCIA_P,P5018,P8524)
# Les pongo nombres entendibles:
colnames(ener_hogar) <- c("ï..DIRECTORIO","SECUENCIA_ENCUESTA",'ORDEN' ,"SECUENCIA_P",'ener_consumo','gas_consumo')

# muchos NA's, se pondrán en 0
ener_hogar <- ener_hogar %>% replace_na(list(ener_consumo=0,gas_consumo=0)) # Reemplazo los NA's los cuales serán aqullos que no tiene consumo

```

Servicios del hogar:

VALORES PARA: - FUENTE_ILUMUNACION: 1 Energía eléctrica 2 Lámpara de Gas
Propano 3 Lámpara de Kereosene, petróleo, gasolina 4 Lámpara de pilas o
baterias 5 Velas

-   SERVICIO SANITARIO: 1 Inodoro conectado a alcantarillado 2 Inodoro
    conectado a pozo séptico 3 Inodoro sin conexión 4 Letrina 5 Inodoro
    con descarga directa a fuentes de agua (bajamar) 6 No tiene servicio
    sanitario

```{r}
base <- read.csv("Servicios del hogar.csv",header = TRUE,sep=";",dec=",")
servicios_hogar<-base[,c("ï..DIRECTORIO", "SECUENCIA_ENCUESTA", "SECUENCIA_P", "I_HOGAR")]

rm(base) ; rm(base_fin)
```

TENENCIA Y FINANCIACIÓN DE LA VIVIENDA (K)

```{r}
#Selección variables y renombrado
base2 <- read.csv("Tenencia y financiación de la vivienda que ocupa el hogar.csv",header = TRUE,sep=";",dec=",")
df2 <- base2 %>% select(ï..DIRECTORIO,SECUENCIA_ENCUESTA,SECUENCIA_P,P5095,P5100,P5110,P5130,P5140,P5160)
colnames(df2) <- c('ï..DIRECTORIO','SECUENCIA_ENCUESTA','SECUENCIA_P','vivienda_es', 'amortizuacion', 'precio_venta', 'precio_arriendo','pago_arriendo', 'subsidio_vivienda')
#Conversión a categoría
cols <- c("vivienda_es", "subsidio_vivienda")
# df2[,cols] <- lapply(df2[,cols], factor)
#Manejo de nulos
df2$amortizuacion[is.na(df2$amortizuacion)] <- "0"
df2$precio_venta[is.na(df2$precio_venta)] <- "0"
df2$precio_arriendo[is.na(df2$precio_arriendo)] <- "0"
df2$pago_arriendo[is.na(df2$pago_arriendo)] <- "0"
df2$subsidio_vivienda[is.na(df2$subsidio_vivienda)] <- "2"
head(df2)

#finalmente seleccionamos las variables:
tenencia_finan <- df2[,c(c('ï..DIRECTORIO','SECUENCIA_ENCUESTA','SECUENCIA_P',"vivienda_es", "subsidio_vivienda"))]

# recodificamos vivienda es:

tenencia_finan <- tenencia_finan %>% 
    mutate(vivienda_es = case_when(
      tenencia_finan$vivienda_es == 1 |
       tenencia_finan$vivienda_es == 2 ~ 1 # tiene casa propia 
      ,tenencia_finan$vivienda_es == 3 ~ 2 # arriendo
      ,tenencia_finan$vivienda_es > 3 ~ 3 # otros: permiso o posesion sin titulo o posesion colectiva
    ))
  
rm(base2) ; rm(df2)
```

# uniones tablas hogar:

```{r}
h1 <- servicios_hogar %>% 
  full_join(ener_hogar, by=c('ï..DIRECTORIO'='ï..DIRECTORIO','SECUENCIA_ENCUESTA'='SECUENCIA_ENCUESTA'))

h2  <- h1 %>% 
  full_join(tenencia_finan, by=c('ï..DIRECTORIO'='ï..DIRECTORIO','SECUENCIA_ENCUESTA'='SECUENCIA_ENCUESTA'))

rm(h1)

rm(ener_hogar) ; rm(servicios_hogar) ; rm(tenencia_finan)
```

# TABLAS DE VIVIENDAS:

sara

```{r}
# Seleccionando directorio de trabajo 

# Lectura y extracción de Variables significativas
# prediciendo el número de hijos de los hogares colombianos

# BASE VIVIENDA
Dt_Vivienda <- read.csv("Datos de la vivienda.csv",header = TRUE,sep = ";")
Dt_Vivienda <- as_tibble(subset(Dt_Vivienda,select = c("ï..DIRECTORIO","SECUENCIA_ENCUESTA","SECUENCIA_P",
                                             "REGION","P1070")))
# segun estudios la region influye el en n. de hijos
# Cambiamos el nombre de las columnas para tener una mejor manipulacion de las variables 
colnames(Dt_Vivienda)[5] <- "TIPO_VIVIENDA"
# Verificar si la base de datos presenta NA's
any(is.na(Dt_Vivienda)) 
colSums (is.na ( Dt_Vivienda )) # No tiene valores NA's

# tener casa o apartamento tiene influencia en el no d hijo que tiene un hogar
 Dt_Vivienda <- Dt_Vivienda %>% 
   mutate(TIPO_VIVIENDA = case_when(
     Dt_Vivienda$TIPO_VIVIENDA == 1 | Dt_Vivienda$TIPO_VIVIENDA == 2 ~ 1 # casa o apartamento
     ,Dt_Vivienda$TIPO_VIVIENDA >= 3 ~ 0 # las demás
   ))
 
 
```

Union final

```{r}
datos <- p3 %>% 
  full_join(h2, by = c('ï..DIRECTORIO' = 'ï..DIRECTORIO', 'SECUENCIA_P'='SECUENCIA_ENCUESTA'))

datos <- datos %>% 
  full_join(Dt_Vivienda, by = c('ï..DIRECTORIO' = 'ï..DIRECTORIO'))

sum((datos$SECUENCIA_P.x == datos$SECUENCIA_P.x.x)*1)


datos <- datos %>% unite("id", ï..DIRECTORIO:SECUENCIA_P.x, remove = FALSE) # uno estas V. para identificar
datos <- datos %>% distinct(id,.keep_all = T) # Selecciono los únicos valores. Ahora tengo los hogares un sus hijo identificado de manera única.
  
# no hay NA´s
colSums(is.na(datos))

# Ahora eliminamos las columnas que no aportan:
datos <- datos %>% select(-c('id', 'ï..DIRECTORIO','SECUENCIA_P.x', 'SECUENCIA_ENCUESTA.x', 'SECUENCIA_P.x.x', 'ORDEN', 'SECUENCIA_P.y', 'SECUENCIA_P.y.y', 'SECUENCIA_ENCUESTA.y', 'SECUENCIA_P.y.y.y','subsidio_vivienda',
                             'ganancia_mes'))

# cambiamos el tipo de cada las columnas a su correspodiente tipo:

caracters <- c('vive_con_conyuge','nvl_educacion_papa','nvl_educacion_mama','rasgos','campesino','A_EPS','SEG_SOCIAL_SALUD','vivienda_es','REGION','TIPO_VIVIENDA')
datos[,caracters] <- apply(datos[,caracters], 2, as.character) 
datos$horas <- as.numeric(datos$horas)
datos <- datos %>% relocate(where(is.numeric), .before = where(is.character))
str(datos)
# esportamos los datos
write.csv(datos,file = 'datos.csv')

```

## Proceso general

El analisis previo del conjunto de datos Calidad de vida en Colombia,
encontrados en el sitio web del DANE se basó inicialmente en lectura
informativas que nos llevaran a entender mejor el problema de predicción
de número de hijos mediantes las caracteristicas de un hogar. Se discute
cada base de datos que conformaba el conjunto total y se realiza una
selección de las variables significativas ya obtenido un conocimiento
previo mediante estudios y articulos encontrados en la web.

Una vez seleccionadas nuestras variables y obtenido nuestro conjunto de
datos final se realiza un analisis de correlación entre variables
númericas para asi determinar y descartar variables posiblementes
redundantes para nuestro analísis. No se encuentran correlaciones
mayores a $0.75$ por lo que se determina dejar todas las variables para
predecir el número de hijos.

Se realizá unas series de pruebas utilizando KNN tanto en la
programación paso a paso implementada en clase como con las funciones
disponibles en el paquete de Caret; los resultados no fueron optimos
debido al tiempo que toma KNN en realizar un proceso de selección de
variables y esto es debido a que escanea la base de datos histórica cada
vez que se necesita una predicción.

Teniendo en cuenta esto se fundamenta la elección previa basada en
articulos y en varias discucines entre los miembros sobre la
interpretación y reinterpretación de las variables tenidas en cuenta en
nuestra base resultante final.

## Procedimiento especifico de modelación

```{r,include=FALSE}
# load libraries
library(caret)
library(tidyverse)
library(dplyr)
library(mlbench)
library(tidyr)
library(fastDummies)
library(randomForest)

```

```{r}
# Directorio de trabajo 
# Lectura de base de datos 
Datos <- read.csv("datos.csv",header = TRUE)
```

### Selección de Variables

El paquete **caret R** proporciona herramientas para informar
automáticamente sobre la relevancia e importancia de los atributos en
los datos e incluso seleccionar las características más importantes. Se
analizará la **Matriz de correlación** para identificar atributos
altamente correlacionados y eliminarlos en cyo caso esta corrleción sea
mayor de 0.75 ya que nos estaria indicando que posiblemente haya
redundancia entre esas dos variables altamente correlacionadas si se
dejan ambas en el modelo ya que una estaria relacionada con la otra
positiva o negativamente segun sea el caso.

Selección de la base de datos con las caracteristicas del hogar, las
cuales son nuestras variables predictivas

```{r}
# Observamos la correlación entre las variables numericas 
Datos_num <- Datos[,c(3:9)]
cor_dt <- cor(Datos_num)
cor_dtHIGH <- findCorrelation(cor_dt,cutoff = 0.5)
# Encontramos que no hay correlaciones mayores a 0.5

# Variables predictivas
Datos_pred <- Datos[,c(2:20)]
```

Cálculo de la desviación estándar:

```{r}
round(apply(Datos_num,2,sd),2)
```

Esto nos permite analizar la variabilidad que hay presente en las
variables numericas.

## KNN

```{r}
# Creación de variables dummies 
Datos_pred <- dummy_cols(Datos_pred, select_columns = c("vive_con_conyuge","nvl_educacion_papa",
                                           "nvl_educacion_mama","rasgos","campesino",
                                           "actividad_semana_pasada","A_EPS","SEG_SOCIAL_SALUD",
                                  "vivienda_es","REGION","TIPO_VIVIENDA"),remove_selected_columns  = TRUE)
```

### Normalizacón de los datos

Con KNN es debido hacer normalización de los datos para que el algoritmo
trabaje las mismas unidades internamente para seleccionar los k vecinos
mas cercanos a una variable.

```{r}
Datos_pred_cent <-scale(Datos_pred,center=TRUE,scale=TRUE)
centro<-attr(Datos_pred_cent,"scaled:center")
escala<-attr(Datos_pred_cent,"scaled:scale")
Datos_pred_cent<-as.data.frame(Datos_pred_cent)
```

### Particionamiento del conjunto de datos

```{r}
set.seed(123)
# Se crean los índices de las observaciones de entrenamiento
train <- createDataPartition(y = Datos_pred_cent$n, p = 0.85, list = FALSE, times = 1)
datos_train <- Datos_pred_cent[train, ]
datos_test  <- Datos_pred_cent[-train, ]
```

Verificar que la variable tenga la misma distribución en el conjunto de
datos de entrenamiento y de prueba:

```{r}
round(prop.table(table(datos_train$n)),2)
```

```{r}
round(prop.table(table(datos_test$n)),2)
```

### Modelos de regresión KNN

Probamos un modelo de regresión KNN con diferentes K y asi evaluar con
nuestro conjunto de entrenamientos y prueba el comportamiento con la
medidas RMSE, se escoge aquel modelo cuya medida RMSE sea minima.

**K=1**

```{r}
# k=1 
inicio <- Sys.time()
knnn <- knnreg(n~. ,data = datos_train, k=1)
predict1 <- predict(knnn, newdata = datos_test)
fin <- Sys.time()
fin-inicio
RMSE1 <- sqrt(mean((predict1-datos_test$n)^2))
RMSE1

saveRDS(knnn,'knn.rds')
rm(knnn)
knnn <- readRDS('knn.rds')

prueba <- datos_test[1,]
p <- predict(knnn, newdata = datos_test[1,])

summary(prueba)
```

**K=3**

```{r}
inicio <- Sys.time()
knn3 <- knnreg(n~. ,data = datos_train, k=3)
predict3 <- predict(knn3, newdata = datos_test)
fin <- Sys.time()
fin-inicio
RMSE3 <- sqrt(mean((predict3-datos_test$n)^2))
RMSE3

saveRDS(knn3,'knn.rds')
rm(knn3)
knn3 <- readRDS('knn.rds')

prueba <- datos_test[1,]
p3 <- predict(knn3, newdata = datos_test[1,])

```

**K=5**

```{r}
inicio <- Sys.time()
knn5 <- knnreg(n~. ,data = datos_train, k=5)
predict5 <- predict(knn5, newdata = datos_test)
fin <- Sys.time()
fin-inicio
RMSE5 <- sqrt(mean((predict5-datos_test$n)^2))
RMSE5

saveRDS(knn5,'knn.rds')
rm(knn5)
knn5 <- readRDS('knn.rds')

prueba <- datos_test[1,]
p5 <- predict(knn5, newdata = datos_test[1,])

```

**K=10**

```{r}
inicio <- Sys.time()
knn10 <- knnreg(n~. ,data = datos_train, k=10)
predict10 <- predict(knn10, newdata = datos_test)
fin <- Sys.time()
fin-inicio
RMSE10 <- sqrt(mean((predict10-datos_test$n)^2))
RMSE10

saveRDS(knn10,'knn.rds')
rm(knn10)
knn10 <- readRDS('knn.rds')

prueba <- datos_test[1,]
p10 <- predict(knn10, newdata = datos_test[1,])

```

**K=15**

```{r}
inicio <- Sys.time()
knn15 <- knnreg(n~. ,data = datos_train, k=15)
predict15 <- predict(knn15, newdata = datos_test)
fin <- Sys.time()
fin-inicio
RMSE15 <- sqrt(mean((predict15-datos_test$n)^2))
RMSE15

saveRDS(knn15,'knn.rds')
rm(knn15)
knn15 <- readRDS('knn.rds')

prueba <- datos_test[1,]
p15 <- predict(knn15, newdata = datos_test[1,])

```

\*\* K=20\*\*

```{r}
inicio <- Sys.time()
knn20 <- knnreg(n~. ,data = datos_train, k=20)
predict20 <- predict(knn20, newdata = datos_test)
fin <- Sys.time()
fin-inicio
RMSE20 <- sqrt(mean((predict20-datos_test$n)^2))
RMSE20

saveRDS(knn20,'knn.rds')
rm(knn20)
knn20 <- readRDS('knn.rds')

prueba <- datos_test[1,]
p20 <- predict(knn20, newdata = datos_test[1,])

```

**K=30**

```{r}
inicio <- Sys.time()
knn30 <- knnreg(n~. ,data = datos_train, k=30)
predict30 <- predict(knn30, newdata = datos_test)
fin <- Sys.time()
fin-inicio
RMSE30 <- sqrt(mean((predict30-datos_test$n)^2))
RMSE30

saveRDS(knn30,'knn.rds')
rm(knn30)
knn30 <- readRDS('knn.rds')

prueba <- datos_test[1,]
p30 <- predict(knn30, newdata = datos_test[1,])
```

Una vez probada la modelación con knnreg() con todas las variables
predictivas de nuestra base de datos se encontro que el menor RMSE para
estos modelos de regresión KNN se tiene con k=20, a medidas que se
aumenta k no se observa diferencia significativa en la mejora del RMSE,
es decir de que este entregue predicciones mejores por lo cual
utilizaremos este para entrenar y validar nuestros datos, asi mismo para
usarlo como estimación en nuestra app web.

Aplicando el inverso de escalamiento de los datos para observar el valor
real:

```{r}
# Predicción del número de hijos para la fila 1 de mi base de datos de prueba. 
p20*escala[1]+centro[1]
```

Se obtubo una respuest cercana a la realidad, subestimando la predicción
realizada pero aun asi con resultados satisfactorios. Aunque tambien se
hizo la prueba con otras observaciones la calidad de la predicción no es
perfecta. Se sugiere para futuros estudios optimizar las variables
predictoras para una mejora del modelo.

### Función para encontrar los vecinos mas cercanos y promediar sus respuestas:

Se quiso utilizar el algoritmo utilizado en clase para realizar cross
validation, Se comenta el procedimiento realizado debido a que la
dimensión de los datos no nos permite tener un tiempo optimo para la
realización del proceso. Por lo cual se descarta su aplicación para este
problema; Ademas de que poseemos un conjunto amplio de observaciones nos
permite fundamentar igualmente la omisión de este procedimiento

```{r}
fknn<-function(x,k,X_tr,Y_tr){
  # x: observación a predecir
  # k: cuántos vecinos más cercanos se deben hallar
  # X0: dataframe o matriz con los datos de entrenamiento
  # Y0: respuesta asociada a X0
  xX<-rbind(x,X_tr) # Se concatenan x y X
  distancias<-as.matrix(dist(xX)) # Se calcula la matriz de distancias y se convierte a la clase matrix
  d_vec<-distancias[1,-1] # Se selecciona la columna 1 que corresponde a todas las distancias con respecto a x
  orden<-sort(d_vec,index.return=TRUE) # Se ordenan las distancias en forma ascendente
  k_vecinos<-orden$ix[1:k] # se obtienen los índices de los k vecinos más cercanos
  respuestas_knn<-Y_tr[k_vecinos] # se extraen las respuestas correspondientes a los k vecinos más cercanos
  r_knn<-mean(respuestas_knn) # se promedian las respuestas de los k vecinos más cercanos
  return(r_knn)
}
```

```{r}
# n<-dim(Datos_pred)[1]
# n_vl<-round(n*0.25)
# set.seed(20190930) # Se fija la semilla para obtener
#                    # resultados reproducibles
# ix_vl<-sample(1:n,n_vl,replace = FALSE)
# X_tr<-Datos_pred[-ix_vl,c(2:46)]
# X_vl<-Datos_pred[ix_vl,c(2:46)]
# Y_tr<-Datos_pred$n[-ix_vl]
# Y_vl<-Datos_pred$n[ix_vl]
# ```
# 
# 
# ```{r}
# fknn(x=X_vl[1,],k=3,X_tr=X_tr,Y_tr=Y_tr)
```

Selección de predictores relevantes

### knn es muy lento cuando se tienen muchas observaciones por que escanea la base de datos hisotorica para hacer predicciones

**Caret::varImp** : cálculo de la importancia de la variable para
modelos de regresión y clasificación

Para cálcular la importancia de una variable primero ajustamos un modelo
genérico lm() con un subconjunto de nuestra base de datos (Datos de
entrenamiento)

```{r}
# # prepare training scheme
# control <- trainControl(method="repeatedcv", number=3, repeats=1)
# # train the model
# model <- train(n~., data=datos_train, method="knn", preProcess="scale", trControl=control)
# # estimate variable importance
# importance <- varImp(model, scale=FALSE)
# # summarize importance
# print(importance)
# # plot importance
# plot(importance)
```

```{r}
# set.seed(03042021)
# 
# # Se configura el método de selección de variables. Se utiliza K-fold cross-validation con K=3.
# rctrl1 <- rfeControl(method = "cv",
#                      number = 3,
#                      returnResamp = "all",
#                      functions = caretFuncs,
#                      saveDetails = TRUE)
# 
# # Selección de variables. Se configura para obtener el mejor modelo con 1 y con 2 variables (sizes=c(1,2)):
# model_select <- rfe(n ~ ., data = datos_train,
#              sizes = c(1, 5, 10, 15),
#              method = "knn",
#              metric = "RMSE",
#              preProcess = c("center","scale"),
#              trControl = trainControl(method = "cv",number = 3),
#              tuneGrid = data.frame(k = 1:10),
#              rfeControl = rctrl1)

```

## Otros modelos probados

```{r, include=FALSE}
library(fastDummies)
datos <- read.csv('datos.csv')
caracters <- c('vive_con_conyuge','nvl_educacion_papa','nvl_educacion_mama','rasgos','campesino','A_EPS','SEG_SOCIAL_SALUD','vivienda_es','REGION','TIPO_VIVIENDA')
datos[,caracters] <- apply(datos[,caracters], 2, as.character)
datos <- datos[,-1]

caracteristicas <- dummy_cols(datos, select_columns = c("vive_con_conyuge",
                                                                    "nvl_educacion_papa",
                                                                    "nvl_educacion_mama",
                                                                    "rasgos",
                                                                    "campesino",
                                                                      'actividad_semana_pasada',
                                                        'A_EPS','SEG_SOCIAL_SALUD','vivienda_es','REGION',
                                                        'TIPO_VIVIENDA' 
                                                        ), 
                                remove_selected_columns = T)
```

### Gráfico de pares:

Podemos observar que no existe mucha correlación con respecto a la
variable número de hijos (variable n) sin embargo probaremos con algunos
modelos lineales:

```{r}
pairs(datos[,1:8], lower.panel = NULL)
```

# Modelos de regresión lineal:

```{r}
library(leaps)
```

Utilizamos regsubset para la selección de las mejore variables:

```{r}
reg_full_fit <- regsubsets(n~.,data = datos, nvmax=34)
sumary <- summary(reg_full_fit)
```

Viendo el R\^2 con una sola variable será de 5.96% pero usando todas
maximo optiene un 18.8%

```{r}
sumary$rsq
```

Plotting RSS, adjusted R2, Cp, and BIC

```{r}
par(mfrow=c(2,2))
plot(sumary$rsq ,xlab=" Number of Variables ",ylab=" R^2", type="o")
plot(sumary$adjr2 ,xlab=" Number of Variables ",ylab=" R^2 adjus", type="o")
plot(sumary$rss ,xlab=" Number of Variables ",ylab=" RSS", type="o")
plot(sumary$bic ,xlab=" Number of Variables ",ylab="BIC", type="o")

```

Al parecer es en general es suficiente utilizar 10 variables para
generalizar un buen modelo:

Forward and Backward y Selection: Se puede observar que se obtienen las
mismas variables para un tamaño adecuado de 10 en todos los métodos de
selección:

```{r}
reg_forw_fit <- regsubsets(n~.,data = datos, nvmax=34, method = 'f')
reg_back_fit <- regsubsets(n~.,data = datos, nvmax=34, method = 'b')

coef(reg_full_fit, 10)
coef(reg_forw_fit, 10)
coef(reg_back_fit, 10)
```

Ahora vamos a realiza la selección de variables utilizando rich y lasso
regresión:

```{r}
#install.packages('glmnet')
library(glmnet)
# matriz de diseño
x <- model.matrix(n~.,datos)[,-1]
y <- datos$n
```

# primero ridge:

```{r}
grid <- 10^seq(10,-1,length=100)
ridge_mod <- glmnet(x,y,alpha = 0, lambda=grid)
plot(ridge_mod)
```

Al parecer algunos coeficientes tienden a cero a medida que se mueven
los valores del lambda: realizamos particionamiento de los datos en
entrenamiento y prueba para realizar validación cruzada y encontrar el
mejor lambda:

```{r}
set.seed (1)
train=sample (1: nrow(x), nrow(x)/2)
test=(-train )
y.test=y[test]
```

Planteamos el modelo:

```{r}
ridge.mod =glmnet (x[train,],y[train],alpha =0, lambda =grid ,
thresh =1e-12)
ridge.pred=predict(ridge.mod ,s=4, newx=x[test ,])
mean(( ridge.pred -y.test)^2)
```

Se obtiene el mejor lambda y luego se calcula la predicción con el

```{r}
# ahora voy a hallar el mejor lambda
set.seed (1)
cv.out =cv.glmnet (x[train ,],y[train],alpha =0)
plot(cv.out)
bestlam =cv.out$lambda.min
bestlam
ridge.pred=predict (ridge.mod ,s=bestlam ,newx=x[test ,])
sqrt(mean(( ridge.pred -y.test)^2))
```

```{r}
out=glmnet (x,y,alpha =0)
rigge.coef <- predict (out ,type="coefficients",s=bestlam )[1:19,]
round(rigge.coef[rigge.coef>0.0001 | rigge.coef<0 ],6)
```

# AHORA REALIZAMOS LASSO:

```{r}
lasso.mod =glmnet (x[train ,],y[train],alpha =1, lambda =grid)
plot(lasso.mod)
```

Aqui se observa que al aumentar los valores de lambda muchos de los
parametros tieneden a cero.

```{r}
set.seed (1)
cv.out =cv.glmnet (x[train ,],y[train],alpha =1)
plot(cv.out)
bestlam =cv.out$lambda.min
lasso.pred=predict (lasso.mod ,s=bestlam ,newx=x[test ,])
sqrt(mean(( lasso.pred -y.test)^2))
```

```{r}
out=glmnet (x,y,alpha =1, lambda =grid)
lasso.coef=predict(out, type ="coefficients",s=bestlam )[1:19,]
lasso.coef[lasso.coef!=0]
```

# los resultado obenido por los diferentes metodos para la selección de variables son:

```{r}
# forward backward y stepwice, sus resultados me dan iguales:
coef(reg_full_fit, 10)
coef(reg_forw_fit, 10)
coef(reg_back_fit, 10)
```

```{r}
# ride: me deja muchas variables
round(rigge.coef[rigge.coef>0.005 | rigge.coef < 0],4)
print('\n')
# lasso
lasso.coef[lasso.coef!=0]
```

# division en entrenamiento y prueba, considerando la cantidad de datos que se tienen, se opta por hacer un particionamiento para modelar en lugar de utilizar validación cruzada:

```{r}
library(caret)
set.seed(1037637276)
intrain <- createDataPartition(y = datos$n, p= 0.85, list = FALSE)
training <- datos[intrain,]
testing <- datos[-intrain,]
```

Modelo lienal con las variables previamente halladas por leaps, con sus
respectivos RMSE:

```{r}
mod_leaps <- lm(n~., data=training[,c('n','edad','X1ER_HIJO_EDAD','TOT_DISPOSITIVOS','I_HOGAR',
                                     'gas_consumo','vive_con_conyuge','rasgos','actividad_semana_pasada','SEG_SOCIAL_SALUD')])
summary(mod_leaps)
pred_leaps <- predict(mod_leaps, newdata = testing)
rmse_leaps <- sqrt(mean((pred_leaps-testing$n)^2)); rmse_leaps
```

modelo hallado con ridge:

```{r}
mod_ridge <- lm(n~.,data = training[,c('n','edad','X1ER_HIJO_EDAD','TOT_DISPOSITIVOS','vive_con_conyuge','nvl_educacion_papa','nvl_educacion_mama','rasgos','campesino','actividad_semana_pasada')])
summary(mod_ridge)
pred_ridge <- predict(mod_ridge, newdata = testing)
rmse_ridge <- sqrt(mean((pred_ridge-testing$n)^2)); rmse_ridge
```

modelo hallado con lasso:

```{r}
mod_lasso <- lm(n~.,data = training[,c('n','edad','X1ER_HIJO_EDAD','vive_con_conyuge','rasgos')])
summary(mod_lasso)
pred_lasso <- predict(mod_lasso, newdata = testing)
rmse_lasso <- sqrt(mean((pred_lasso-testing$n)^2)); rmse_lasso
```

Podemos concluir que el mejor modelo según el RMSE de prueba es el
construido con los métodos de forward, backward y stepwyse, pero su
diferencia es por poco.

Ahora será necesaria la validación de supuestos:

```{r}
par(mfrow=c(2,2))
plot(mod_leaps)
```

```{r}
par(mfrow=c(2,2))
plot(mod_lasso)
```

```{r}
par(mfrow=c(2,2))
plot(mod_ridge)
```

Concluimos que los modelos tienen serios problemas con el cumplimiento
de los supuestos de homocedasticidad y de normalidad de los errores. Se
intentaron plantear algunas transformaciones, pero no se observa un
patrón claro en los gráficos de los errores para aplicar determinada
transformación como una forma cuadrática o exponencial.

Hallamos box cox con el propósito de lograr cumplir el supuesto de
normalidad, pero, no puede ser hallada pues los valores de la variable
respuesta deben ser positivos y hay muchos ceros.

```{r}
# library(MASS)
# #find optimal lambda for Box-Cox transformation 
# bc <- boxcox(n~., data= datos[,c('n','edad','X1ER_HIJO_EDAD','vive_con_conyuge','rasgos')])
# (lambda <- bc$x[which.max(bc$y)])
# 
# #fit new linear regression model using the Box-Cox transformation
# new_model <- lm(((y^lambda-1)/lambda) ~ x)  
```

# tree regression:

Ahora se realiza el ajuste del modelo con un valor cp(parámetro de
complejidad) pequeño, que nos ayudará a encontrar una profundidad
adecuada para obtener el mejor árbol, es decir que tenga menor error de
entrenamiento. Una cualidad de los árboles de regresión es que no hay
que realizar una previa selección de variables, él tomara en su raíz las
que considera más importantes, y la siguiente salida de R nos mostrará
los resultados de las variables seleccionadas:

```{r}
library(caret)
set.seed(1037637276)
intrain <- createDataPartition(y = datos$n, p= 0.85, list = FALSE)
training <- datos[intrain,]
testing <- datos[-intrain,]
    
library(rpart)
mod_tree <- rpart(n~.,  method = "anova", data=training, control = rpart.control(cp=.0001))
```

A continuación, podaremos el árbol de regresión para encontrar el valor
óptimo que se usará para cp (el parámetro de complejidad) que conduce al
error de prueba más bajo.

```{r}
#identify best cp value to use
best <- mod_tree$cptable[which.min(mod_tree$cptable[,"xerror"]),"CP"]

#produce a pruned tree based on the best cp value
pruned_tree <- prune(mod_tree, cp=best)
```

Su gráfica será esta, aunque no se alcanza a ver mucho:

```{r}
library(rpart.plot)
#plot the pruned tree
prp(pruned_tree,
    faclen=0, #use full names for factor labels
    extra=1, #display number of obs. for each terminal node
    roundint=F, #don't round to integers in output
    digits=5) #display 5 decimal places in output
```

predicciones:

```{r}
p <- predict(mod_tree, testing, method = "anova")
# este es el error de prueba:
rmse_tree <- sqrt(mean((p-testing$n)^2));rmse_tree
```

finalmente comparamos los RMSE de los modelos:

```{r}
rmse_lasso
rmse_leaps
rmse_ridge
rmse_tree
```

numéricamente los valores son muy similares, pero favoreciendo al árbol,
pero podríamos quedarnos con el modelo de árboles de decisión pues no
debe cumplir con supuestos, a diferencia de los demás que tienen serios
problemas con sus supuestos.

## Conclusión

El mejor modelo resulto siendo KNN con K=20 con un RMSE de 0.875389
seguido por el segundo mejor con un RMSE de 1.047902 para los arboles de
regresión.

# INFORME

Reporte técnico aplicación web de predicción del número de hijos en
hogares colombianos

Presentado por: - Juan Pablo Carvajal Garcia - Sara Camila Hoyos Montoya
- Juan Pablo Ortega Medina - Juan Manuel Pajoy Lopez - Oliver Orley
Rodriguez Berrocal

## Introducción

A lo largo del tiempo se ha logrado evidenciar el cómo implican
diferentes variables en el crecimiento demográfico de un país tanto
desarrollado como por el contrario en vía de desarrollo como lo es
Colombia, por lo que es de vital importancia prestarles oportuna
atención debido a la existencia del vínculo que hay entre la demografía
y la calidad de vida de las personas y la pobreza del país [1].
Variables clave como la educación marcan la diferencia que rompe el
círculo vicioso que se encuentra entre la desinformación y la
maternidad, lo que desencadena en un crecimiento descontrolado del
tamaño del hogar.

Para entender el crecimiento del tamaño del hogar debemos clasificar
diferentes factores que influyen tanto en el deseo de la cantidad de
hijos como en los hijos obtenidos realmente por núcleo familiar. Algunos
de estos factores son el estado socioeconómico de la familia teniendo en
cuenta ingresos y riqueza, el nivel de escolaridad puesto que las
familias que poseen un nivel de escolaridad más bajo tienden a tener
menores conocimientos sobre el uso de métodos anticonceptivos. Por otro
lado, factores que afectan el número de hijos en el hogar son es estado
civil y aspectos culturales como lo puede ser pertenecer a diferentes
etnias o religiones [2].

El principal foco de estudio para determinar el número de hijos
presentes en el hogar está en averiguar cuál es la calidad de vida de
las personas presentes en aquel núcleo familiar, pues esto está ligado a
su nivel de educación y a su esperanza de lograr oportunidades laborales
para mejorar aquella calidad de vida que se está viendo afectada.
Contraproducente a esto debido a la desinformación y a la falta de
acceso a recursos y métodos de planificación familiar, el número de
hijos crece o se tienen más hijos con la esperanza de que estos en el
futuro sean un aporte más para la casa, lo que resume en aquel círculo
vicioso en donde por mala educación sexual la pobreza crece.

Nos resulta natural entonces pensar que en los lugares más marginados
encontraremos aquel número de hijos no deseados mayor, además de las
áreas rurales en donde por la esperanza de mano de obra y costumbres aún
áridas, se permita que el número de hijos crezcan significativamente lo
cual resulta en una afectación a la pobreza y la falta de acceso a los
recursos.

Se es necesario que el gobierno tenga en cuenta estos focos de
crecimiento demográfico y los ataque con planes de protección, programas
de planificación familiar y subsidios de educación, tanto con el fin de
bajar el índice de crecimiento demográfico con hijos no deseados, como
por el deseo de mejorar la calidad de vida de la población yaciente en
el seno del problema.

Gracias a esto se realiza una aplicación web enfocada para programas
gubernamentales donde estos puedan con esta, encontrar hogares y zonas
vulnerables donde se puedan invertir los recursos para mejorar la
calidad de vida de las personas. Esto por medio de programas como lo son
Familias en acción, mejoramiento de vivienda, subsidio familiar, jóvenes
en acción, generación E, nutrición, programas de planificación familiar
y entre otras ayudas que atacan directamente los causante del
crecimiento acelerado de la población por nacimientos no deseados en
lugares marginados o con falta de recursos. Esto por medio de una
aplicación sencilla de manejar, intuitiva, rápida y eficaz con un modelo
entrenado por medio de una base de datos con el historial de la
población colombiana censada en el año 2019.

## Retos

Partiremos de la información suministrada por La Encuesta de Calidad de
Vida (ECV) la cual es una investigación que el DANE realiza con el
objetivo de de recopilar la información de los hogares colombianos
permitiendo así tener una visión general de las condiciones de vida de
los hogares, teniendo diversos aspectos como lo son el acceso a bienes y
servicios públicos, privados o comunes, salud, educación, atención
integral de niños y niñas menores de 5 años, el uso energético,
tecnologías de información y comunicación, entre otras variables [3].

Estas encuestas de calidad de vida han permitido mejorar la captura de
información permitiendo así promover la investigación sobre las
condiciones de vida del hogar [3], donde para nuestro caso nos servirá
como fuente para identificar la relación entre las variables que nos
encontramos en los hogares y predecir el número de hijos en hogares
colombianos.

Las variables más importantes suministradas por la encuesta se
encuentran relacionadas por temática como se muestra:

Tabla 1. Variables relacionadas por temática tomadas de [3]

+----------------------+----------------------+----------------------+
| Temática             | Variables más        | Descripción de la    |
|                      | importantes          | temática             |
+======================+======================+======================+
| Tipo de vivienda y   | Material de paredes  | Capta información    |
| sus características  | y pisos              | relacionada con las  |
| físicas              |                      | características de   |
|                      |                      | la vivienda (tipo de |
|                      |                      | vivienda, material   |
|                      |                      | de pisos y paredes,  |
|                      |                      | servicios públicos,  |
|                      |                      | privados o comunales |
|                      |                      | y afectaciones       |
|                      |                      | procedentes de       |
|                      |                      | desastres naturales  |
|                      |                      | o contaminación en   |
|                      |                      | el entorno)          |
+----------------------+----------------------+----------------------+
| Servicios del hogar  | Conexión a servicios | Se busca información |
|                      | públicos, privados o | relacionada con      |
|                      | comunales y calidad  | hacinamiento         |
|                      | de los mismos y      | crítico, calidad de  |
|                      | clasificación de     | los servicios con    |
|                      | basuras              | que cuente el hogar  |
+----------------------+----------------------+----------------------+
| Variables            | Sexo, edad,          | Se busca identificar |
| demográfica          | parentesco, estado   | las personas que     |
|                      | civil, migración,    | conforman el hogar y |
|                      | estudios de padre y  | establecer su        |
|                      | madre cuando estos   | parentesco con el    |
|                      | noresiden en el      | jefe(a) del hogar.   |
|                      | hogar                | Además, se realiza   |
|                      |                      | una caracterización  |
|                      |                      | demográfica de todos |
|                      |                      | los integrantes en   |
|                      |                      | aspectos como sexo,  |
|                      |                      | edad, estado civil,  |
|                      |                      | autoreconocimiento   |
|                      |                      | étnico y campesino,  |
|                      |                      | sitio y lugar de     |
|                      |                      | nacimiento,          |
|                      |                      | migración, y se      |
|                      |                      | indaga por el        |
|                      |                      | bienestar subjetivo  |
|                      |                      | de las personas de   |
|                      |                      | 15 años y más.       |
+----------------------+----------------------+----------------------+
| Salud                | Cobertura del SGSSS  | Se busca obtener     |
|                      | por regímenes,       | información sobre    |
|                      | morbilidad, acciones | las personas que     |
|                      | tomadas para         | manifiestan estar    |
|                      | enfrentar            | afiliadas al SGSSS y |
|                      | enfermedades         | su afiliación por    |
|                      | padecidas durante    | regímenes, el uso de |
|                      | los últimos 30 días, | los servicios de     |
|                      | tiempo para la       | medicina general,    |
|                      | atención en          | medicina             |
|                      | urgencias y para la  | especializada, entre |
|                      | consulta médica,     | otras                |
|                      | fuentes para cubrir  |                      |
|                      | los gastos en salud  |                      |
|                      | y opinión sobre la   |                      |
|                      | calidad de los       |                      |
|                      | servicios            |                      |
+----------------------+----------------------+----------------------+
| Cuidado de los niños | Sitio de permanencia | Se busca identificar |
| y niñas menores de 5 | de los niños menores | la persona o         |
| años                 | de cinco años        | institución sobre la |
|                      | durante lamayor      | cual recae la        |
|                      | parte del tiempo     | responsabilidad de   |
|                      | entre semana, tipo   | la atención y        |
|                      | de hogar             | cuidado de los niños |
|                      | comunitario,         | y niñas menores de 5 |
|                      | guardería, jardín o  | años. Igualmente     |
|                      | centro de desarrollo | determinar el acceso |
|                      | infantil al que      | a los                |
|                      | asisten, persona que | establecimientos     |
|                      | se encarga del       | públicos y privados  |
|                      | cuidado de los niños | destinados a la      |
|                      | menores de 5 años,   | protección y         |
|                      | niños que son        | aprendizaje de       |
|                      | llevados a control   | los(as) menores      |
|                      | de crecimiento y     |                      |
|                      | desarrollo           |                      |
+----------------------+----------------------+----------------------+
| Educación (personas  | Alfabetismo,         | El objetivo es       |
| de 5 años y más)     | asistencia escolar,  | identificar las      |
|                      | máximo nivel         | principales          |
|                      | educativo alcanzado  | características      |
|                      | y último año         | educativas de la     |
|                      | aprobado o que esté  | población de 5 años  |
|                      | cursando, tasas      | y más, en particular |
|                      | brutas y netas de    | el alfabetismo, la   |
|                      | escolaridad, becas,  | asistencia escolar,  |
|                      | subsidios y créditos | los niveles          |
|                      |                      | educativos           |
|                      |                      | alcanzados y años de |
|                      |                      | estudio. Entre otras |
|                      |                      | cosas                |
+----------------------+----------------------+----------------------+
| Fuerza de trabajo    | Población            | Se busca identificar |
| (personas de 12 años | económicamente       | características      |
| y más)               | activa (PEA),        | laborales las cuales |
|                      | población            | dan indicios sobre   |
|                      | económicamente       | la capacidad         |
|                      | inactiva (PEI),      | adquisitiva, de      |
|                      | actividad semana     | tiempo y de          |
|                      | pasada, actividades  | beneficios laborales |
|                      | pagas, posición      | que afectarían la    |
|                      | ocupacional, sitio   | vida de los miembros |
|                      | de trabajo, tamaño   | del hogar.           |
|                      | de la empresa, tipo  |                      |
|                      | de transporte        |                      |
|                      | utilizado para       |                      |
|                      | desplazarse al       |                      |
|                      | trabajo e ingresos,  |                      |
|                      | subsidios recibidos, |                      |
|                      | ganancias obtenidas. |                      |
+----------------------+----------------------+----------------------+
| Trabajo infantil     | Actividad principal  | Tiene como objetivo  |
|                      | realizada por los    | conocer la           |
|                      | menores de 5 a 11    | participación de los |
|                      | años en la semana de | niños(as) entre 5 y  |
|                      | referencia,          | 11 años en           |
|                      | ocupación,actividad  | actividades          |
|                      | donde realizan la    | económicas y no      |
|                      | labores, ingresos    | económicas. Asimismo |
|                      | percibidos y sitios  | determinar la        |
|                      | de trabajo y horas   | proporción de        |
|                      | trabajadas           | menores que          |
|                      |                      | participan del       |
|                      |                      | mercado laboral y    |
|                      |                      | caracterizar su      |
|                      |                      | forma de             |
|                      |                      | participación.       |
+----------------------+----------------------+----------------------+
| Tenencia y           | Tipo de tenencia de  | Se busca establecer  |
| financiación de la   | la vivienda;         | la condición de      |
| vivienda             | tenencia de          | ocupación de la      |
|                      | escritura de         | vivienda por parte   |
|                      | propiedad; subsidios | del hogar y obtener  |
|                      | recibidos para la    | información con      |
|                      | compra,              | respecto a los       |
|                      | construcción,        | subsidios para       |
|                      | mejora, titulación o | vivienda             |
|                      | escrituración de la  | provenientes del     |
|                      | vivienda             | gobierno o de otra   |
|                      |                      | institución.         |
+----------------------+----------------------+----------------------+
| Condiciones de vida  | Percepción del jefe  | Se indaga sobre la   |
| del hogar            | o cónyuge sobre las  | percepción en cuanto |
|                      | condiciones de vida  | a pobreza,           |
|                      | del hogar, hechos de | inseguridad, la      |
|                      | los que han sido     | ocurrencia de hechos |
|                      | víctimas los         | violentos y la       |
|                      | miembros del hogar   | capacidad de los     |
|                      | en los últimos 12    | ingresos del hogar   |
|                      | meses, ayudas o      | para cubrir los      |
|                      | subsidios recibidos  | gastos mínimos.      |
|                      | por miembros del     | Igualmente se busca  |
|                      | hogar en los últimos | conocer los bienes   |
|                      | 12 meses, tenencia   | que posee el hogar,  |
|                      | de bienes en el      | no solamente como    |
|                      | hogar y conexión a   | patrimonio, sino     |
|                      | internet.            | como satisfactores   |
|                      |                      | de necesidades.      |
+----------------------+----------------------+----------------------+
| Tecnologías de       | Frecuencias de uso   | Se encarga de medir  |
| información y        | de computador y de   | el acceso a las      |
| comunicación         | internet, lugares de | Tecnologías de       |
|                      | acceso a Internet y  | Información y        |
|                      | servicios o          | Comunicación (TIC),  |
|                      | actividades para uso | con enfoque en el    |
|                      | de internet y        | uso del computador y |
|                      | tenencia de celular. | la Internet,         |
|                      |                      | indagando por:       |
|                      |                      | lugares de uso,      |
|                      |                      | frecuencia de uso,   |
|                      |                      | actividades          |
|                      |                      | realizadas a través  |
|                      |                      | de Internet,tenencia |
|                      |                      | y uso de la          |
|                      |                      | telefonía móvil      |
|                      |                      | celular de las       |
|                      |                      | personas de 5 años y |
|                      |                      | más.                 |
+----------------------+----------------------+----------------------+

Partiendo de esto, con las variables identificadas, es necesario
realizar una selección de las más importantes que influyen o pueden
influir en el número de hijos por hogar, además de identificar las
variables con datos nulos y la posible recodificación de estos para
facilitar el análisis y estudio estadístico de los datos obtenidos.

Tras realizar el análisis exploratorio de los datos y seleccionar las
variables de importancia, el próximo reto es intentar reducir el número
de variables con el fin de facilitar el entrenamiento del modelo y que
no se vayan a pedir datos que en el fondo no son relevantes para el
resultado final.

..........

Materiales y métodos

Luego de hacer una larga búsqueda por todas las bases de datos otorgadas
por el DANE en la encuesta de calidad de vida, se tomó la decisión de
enfocarse en las variables que tuvieran que ver con el nivel de vida de
los hogares y algunas con la información del jefe del hogar, ya que se
pensó en un primer momento que podrían ser indicadores de la cantidad de
hijos en el hogar. Luego de esto, se agruparon los hogares y se contaron
cuáles eran hijos para determinar cuántos hijos había en cada hogar, y
en cuanto a las variables de personas sólamente se tuvieron en cuenta
las que tenían que ver con el jefe del hogar. La mayoría de las
variables categóricas tuvieron que ser re codificadas para que el modelo
redujera su complejidad. Esta recodificación se puede ver en la parte de
consolidación de datos.

Para el entrenamiento de los modelos se plantearon 2 modelos de
regresión lineal, un árbol de regresión y el método knn para la
predicción de la cantidad de hijos por hogar, la descripción de todo
este proceso se realizó en Rmd y se puede ver reflejado en la parte de
los modelos.

Resultados

Al realizar un análisis de las variables, se puede evidenciar que todas
las variables son relevantes para el problema y es bueno mantenerlas
todas para obtener una mejor predicción.

Comparando los modelos planteados, se utilizó la métrica del rmse para
observar cuál modelo se comportaba mejor, el resultado de éste fue que
el menor rmse lo tenía el modelo que usaba el método knn, por lo tanto
será el modelo escogido para realizar la predicción de la cantidad de
hijos por hogar.

Conclusiones

Es fácil pensar que las familias campesinas tienen más hijos que las
personas que viven en la ciudad, sin embargo según estos resultados, la
cantidad de hijos en un hogar no depende tanto de eso sino que depende
más de la educación que tengan los jefes del hogar.

Podemos observar que el método de knn para la predicción de variables
resulta muy simple de implementar y tiene unos muy buenos resultados
especialmente para este caso de uso

Se puede apreciar que aunque había muchos datos para analizar había que
hacer un buen tratamiento de éstos para poder llegar a una conclusión
medianamente correcta, el rmse resultante para este caso fue un poco
mayor de 1.

Referencias

[1] Núñez Méndez, Jairo Augusto; Cuesta Rueda, Laura Andrea (2006).
Demografía y pobreza en Colombia. [Online].
Available:<https://repositorio.uniandes.edu.co/handle/1992/8008>

[2] FORERO, Nohora and GAMBOA, Luis Fernando. Family Size in Colombia:
Guessing or Planning? Intended vs. Actual Family Size in Colombia.
Desarro. soc. [online]. 2009, n.64 [cited 2021-04-05], pp.85-118.
Available from:
<http://www.scielo.org.co/scielo.php?script=sci_arttext&pid=S0120-35842009000200004&lng=en&nrm=iso>.
ISSN 0120-3584.

[3] Dirección de Metodología y Producción Estadística (2019).
Metodología Encuesta Nacional de Calidad de Vida - ECV
